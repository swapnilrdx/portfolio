<!DOCTYPE html>
<html>

	<head>
		<title> BUY Page </title>
		<meta charset=utf-8 name="viewport" content="width=device-width, initial-scale=1.0"/>
		<link rel="stylesheet" href="buy.css" />
		<script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>
		<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-database.js"></script>
	</head>
	
	<body style="background-image: linear-gradient( #498fd4, #3d79b4,#336699, #3d79b4, #498fd4);">
		<form id="form">
			<div class="detail_container">	
				<center>		
				<p > 
					<b>Account &nbsp;:&nbsp;&nbsp;</b> 
					<label style="background-image: linear-gradient(to bottom,rgb(255, 94, 0),orange);font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" id="user_details">
				
					</label>
				</p> <br>
				<b>Select Company from following :</b>
				<Select class="dropdown" id="cmp_dropdown">
					<option value="default">Select Comapny from following :</option>
					<option value="Housing Development Finance Corporation Ltd">Housing Development Finance Corporation Ltd.</option>
					<option value="Cipla">Cipla</option>
					<option value="State Bank Of India">State Bank Of India</option>
					<option value="Dr Reddys Laboratories Ltd">Dr. Reddys Laboratories Ltd.</option>
					<option value="HDFC Bank Ltd">HDFC Bank Ltd.</option>
					<option value="Hero MotoCorp Ltd">Hero MotoCorp Ltd.</option>
					<option value="Infosys Ltd">Infosys Ltd.</option>
					<option value="Kotak Mahindra Bank Ltd">Kotak Mahindra Bank Ltd.</option>
					<option value="Lupin">Lupin</option>
					<option value="Oil & Natural Gas Corporation Ltd">Oil & Natural Gas Corporation Ltd.</option>
					<option value="Reliance Industries Ltd">Reliance Industries Ltd.	</option>
					<option value="Tata Steel Ltd">Tata Steel Ltd.</option>
					<option value="Larsen & Toubro Ltd">Larsen & Toubro Ltd.</option>
					<option value="Mahindra & Mahindra Ltd">Mahindra & Mahindra Ltd.</option>
					<option value="Tata Motors Ltd">Tata Motors Ltd.</option>
					<option value="Hindustan Unilever Ltd">Hindustan Unilever Ltd.</option>
					<option value="Asian Paints Ltd">Asian Paints Ltd.</option>
					<option value="ITC Ltd">ITC Ltd.</option>
					<option value="Wipro Ltd">Wipro Ltd.</option>
					<option value="Sun Pharmaceutical Industries Ltd">Sun Pharmaceutical Industries Ltd.</option>
					<option value="ICICI Bank Ltd">ICICI Bank Ltd.</option>
					<option value="Axis Bank Ltd">Axis Bank Ltd.</option>
					<option value="Bharti Airtel Ltd">Bharti Airtel Ltd.</option>
					<option value="Maruti Suzuki India Ltd">Maruti Suzuki India Ltd.</option>
					<option value="Tata Consultancy Services Ltd">Tata Consultancy Services Ltd.</option>
					<option value="NTPC Ltd">NTPC Ltd.</option>
					<option value="Power Grid Corporation Of India Ltd">Power Grid Corporation Of India Ltd.</option>
					<option value="Adani Ports and Special Economic Zone Ltd">Adani Ports and Special Economic Zone Ltd.</option>
					<option value="Bajaj Auto Ltd">Bajaj Auto Ltd.</option>
					<option value="Coal India Ltd">Coal India Ltd.</option>						
				</Select><br><br>
				</center>
				<div class="buy_details" style="position: absolute;left:38%">
					<b>Investment Date 		:</b> &nbsp;&nbsp;&nbsp; <input type="date" id="invst_date"> <p></p><br>

					<b>Investment Price 	:</b> &nbsp;&nbsp; <input type="number" id="invst_price"> <p></p><br>

					<b>Brokrage				:</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
											<input type="number" id="brokrage" onmouseover="brokragepopup()" onmouseout="clearpop()">
												<p id="brokragepopup" style="font-size: 13px;color: red;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-weight: bold"></p><br>

					<b>Other Taxes			:</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
											<input type="number" id="ot" onmouseover="otpopup()" onmouseout="clearpop()">
												<p id="otpopup" style="font-size: 13px;color: red;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-weight: bold"></p><br>
											
					<b>Quantity 			:</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
												<input type="number" id="quan"> 
					<br>			
				</div>
			</div>
			<br> <br>
			<div class="heading" style="position: absolute;left:38%;top:63%;">
					<div class="text_container">
						<p align="center">
							<h3 class="text" style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;font-size: 25px">
								&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD STOCKS
							</h3>
						</p>
					</div>
					<div class="save_btn" style="position:absolute;left:0%;">
						<button type="button" id="save" style="background-image: linear-gradient(to bottom,rgb(255, 81, 0),rgb(255, 145, 0),orange)">
							SAVE
						</button>
					</div>
					<div class= "reset_btn" style="position:absolute;left:70%">
						<button id="Reset" type="reset" style="background-image: linear-gradient(to bottom,rgb(255, 81, 0),rgb(255, 145, 0),orange)">
							RESET
						</button>
					</div>
			</div>
			<br> <br>
			<button id="dashboard" formaction="index.html" style="position: absolute;left:43.15%;top:84%;background-image: linear-gradient(to bottom,rgb(255, 81, 0),rgb(255, 145, 0),orange);">
				DASHBOARD
			</button>
		</form>
	</body>
	<script>
		//========================================================================
		// Your web app's Firebase configuration
		var firebaseConfig = {
			apiKey: "AIzaSyBq4HoajN_88rmVgbqBfJ3xWgbmc6t4zG4",
			authDomain: "portfolio-37e60.firebaseapp.com",
			databaseURL: "https://portfolio-37e60.firebaseio.com",
			projectId: "portfolio-37e60",
			storageBucket: "portfolio-37e60.appspot.com",
			messagingSenderId: "202727189125",
			appId: "1:202727189125:web:e6c82b94bf7edfe9"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		$(document).ready(function(e) {
            firebase.auth().onAuthStateChanged(function(user) {
                console.log("Auth State Changed");                
                if (user) 
                {	
                    var user = firebase.auth().currentUser;                    
                    if (user != null) {
                        email = user.email;
                        emailVerified = user.emailVerified;                    
                        
                        var userID = firebase.auth().currentUser.uid;
                        console.log(userID);
                        var rootref =firebase.database().ref("users").child(userID);
                        
                        rootref.once("value").then(function(snapshot){
                            var name = snapshot.child("name").val();                            
                            console.log(name);
                            $('#user_details').append(name);

                        });
                                                
                        // The user's ID, unique to the Firebase project. Do NOT use
                        // this value to authenticate with your backend server, if
                        // you have one. Use User.getToken() instead.

                        //$('#user_details').append(email);
                    }
                }
                else 
                {
                   console.log("user is null"); 
				   window.alert("Login First");
                   window.open("login.html","_self");
                }
            });
		});


		$("#save").click(function(){
			//conso.log('save btn clicked')
			var cmpName = $("#cmp_dropdown option:selected").val();
			var instDate = $("#invst_date").val();
			var instPrice = $("#invst_price").val();
			var quantity = $("#quan").val();
			var brokrage =$("#brokrage").val();
			var brokrageN =parseFloat(brokrage);
			var ot = $('#ot').val();
			var otN = parseFloat(ot)
			var instPriceN = parseFloat(instPrice)+parseFloat(brokrage)+parseFloat(ot);
			instPrice=instPriceN.toString();
			var quantityN = parseInt(quantity);		
			//conso.log(brokrage,ot)
			//conso.log("CmpName : "+cmpName,typeof(cmpName));
			//conso.log("instDate : "+instDate,typeof(instDate));
			//conso.log("instPrice : "+instPrice,typeof(instPrice));
			//conso.log("quantity : "+quantity,typeof(quantity));
			//conso.log("brokrage : "+brokrage,typeof(brokrage));
			//conso.log("brokrageN : "+brokrageN,typeof(brokrageN));
			//conso.log("ot : "+ot,typeof(ot));
			//conso.log("otN : "+otN,typeof(otN));
			//conso.log("instPriceN : "+instPriceN,typeof(instPriceN));
			//conso.log("quantityN : "+quantityN,typeof(quantityN));
			//for checking whether the input by user is correct or not
			if(cmpName == "default"){
				window.alert("Select Comapny Name...");
			}	
			else if ( instDate == ""){
				
				window.alert("Enter Valid Date...");
			}	
			else if ( instPriceN <= 0 || instPrice == "" || Number.isNaN(instPriceN)){
				
				window.alert("Enter Valid Buy Price...");
			}
			else if (quantityN <= 0 || quantity == ""){		
				window.alert("Enter Valid Quantity...");
			}
			else if(brokrage=="" || Number.isNaN(brokrageN) || brokrageN<0){
				window.alert("Enter valid brokrage...");
			}
			else if(ot=="" || Number.isNaN(otN) || otN<0){
				window.alert("Enter valid Other taxes...");
			}
			//user has entered corrrect and valid input 
			else{	
				var today=new Date();
                var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
				if (quantityN > 0 || quantity != ""){
					var n=parseInt("-1");
					n=quantity.indexOf(".");
					//conso.log(n)
					if(parseInt(n)>-1){
						window.alert("quantity must be integer...");
						return;
					}	                    
					if(convertdates(instDate)>convertdates(date)){
						window.alert('You cannot buy stocks at day which is in future');
						return;
					}
					else{
						firebase.auth().onAuthStateChanged(function(user){
						console.log("Auth State Changed");	
						var user = firebase.auth().currentUser;                    
						if (user != null) {
							var userID = firebase.auth().currentUser.uid;
							//creating "ROOTREF" for traversing to required note
							var rootRef = firebase.database().ref().child("users").child(userID).child("stocks");	

							//creating a snapshot for retreiving current values present in database					
							rootRef.once("value").then(function(snapshot){
								//creating var for checking wheather database contains company list in stocks node 
								//and datelist and total quantity nodes present in company node 
								//"hasdate" for checking whesther the user have stocks of same company purchased on same date
								var hascmplist=snapshot.hasChild("cmplist");
								var hastqty=snapshot.child(cmpName).hasChild("TotalQty");
								var hasdatelist=snapshot.child(cmpName).hasChild("datelist");
								var hasdate=snapshot.child(cmpName).hasChild(instDate);							
								//conso.log("hascompany:"+hascmplist,"\nhas total qyantity:"+hastqty,"\nhasdatelist:"+hasdatelist,"\nsame date:"+hasdate);
								//condition to check wheather company , total quantity ,datelist already present or not 
								if(hascmplist || hastqty || hasdatelist){									
									var cmplist=snapshot.child("cmplist").child("cmplist").val();
									//conso.log(cmplist,typeof(cmplist));
									//converting companylist into cmp names array
									var cmpnames=cmplist.split(",");
									//conso.log(cmpnames,typeof(cmpnames));
									var cmpflag=parseInt(0);

									var cmpflag=cmplist.includes(cmpName);
									//conso.log("Company Present?:"+cmpflag);
									if(!cmpflag){
										var cmplists=cmplist.toString();
										//conso.log(cmplists,typeof(cmplists));	
										var newcmplist=cmplists+","+cmpName.toString();
										//conso.log('Comapny not present');
										rootRef.child("cmplist").set({
										"cmplist":newcmplist	
										});
										//conso.log(newcmplist);
										//conso.log("company list updated");
									}
									

									if(hasdatelist){
										//this will execute if date list is present 
										var datelist=snapshot.child(cmpName).child("datelist").child("datelist").val();	
										//conso.log(datelist,typeof(datelist));
										var dateflag=parseInt(0);
																			
										if(hasdate){
											//if same date is already present we have to calculate average and make some changes 	
											dateflag=parseInt(1);
											//conso.log(dateflag);											
											//conso.log("same date");
											var buyprice=snapshot.child(cmpName).child(instDate).child("Investment Price").val();
											var buyqty=snapshot.child(cmpName).child(instDate).child("Quantity").val();
											//conso.log(buyprice);
											//conso.log(buyqty);									
											var TotalQty =  snapshot.child(cmpName).child('TotalQty').child('TotalQty').val();
											var TotalQtyN = parseInt(TotalQty);
											//conso.log(TotalQtyN);
										
											average(hasdate,buyprice,buyqty,instPriceN,quantityN,cmpName,instDate,TotalQtyN);
										}
										else if(!hasdate){
											//as new date is different we have to update datelist
											datelist=datelist.toString();
											var newdatelist=datelist+instDate.toString()+",";
											rootRef.child(cmpName).child("datelist").set({
											"datelist":newdatelist	
											});
											//conso.log(newdatelist)
											//conso.log("datelist updated")

										}												
									}	
									//if company is present but datelist is not present 
									else if(!hasdatelist){
										//create datelist
										var datelist=instDate.toString();
										rootRef.child(cmpName).child("datelist").update({
											"datelist":datelist+','
										});
										//conso.log("datelist created")
									}

									if(hastqty){
										// total quantity node already present 
										if(!hasdate){
											//as 'hasdate' is false 
											//conso.log("no same date so update total quantity")
											var TotalQty =snapshot.child(cmpName).child("TotalQty").child("TotalQty").val();
											//conso.log(TotalQty);	
											//conso.log(typeof(TotalQty));							
											var newTotalQty=parseInt(TotalQty)+parseInt(quantityN);
											//conso.log(newTotalQty);
											//conso.log(typeof(newTotalQty));
											var newTotalQtys=newTotalQty.toString();
											rootRef.child(cmpName).child("TotalQty").set({
												"TotalQty":newTotalQtys
											});									
										}
									}
									else if(!hastqty){
										var TotalQty=quantity.toString();
										rootRef.child(cmpName).child("TotalQty").update({
											"TotalQty":TotalQty
										});
										//conso.log("total quantity created")
									}						
								}
								else{
									var cmplist=cmpName.toString();
									var datelist=instDate.toString();
									var TotalQty=quantity.toString();

									rootRef.child("cmplist").set({
										"cmplist":cmplist
									});
									//conso.log("company list created");
									rootRef.child(cmpName).child("TotalQty").set({
										"TotalQty":TotalQty
									});
									//conso.log("total quantity created")
									rootRef.child(cmpName).child("datelist").set({
										"datelist":datelist+','
									});
									//conso.log("datelist created")
								}
								//conso.log(hasdate)
								if(!hasdate){
									var date =rootRef.child(cmpName).child(instDate);
									var unitprice=parseFloat(instPriceN)/parseFloat(quantityN);
									var cmpData = {								
										"Investment Price": instPrice,
										"Quantity": quantity.toString(),
										"Unit Price":unitprice.toString()
									}; 
									date.set(cmpData,function(error){
										if(error){
											var errorcode=error.code;
											var errorMessage=error.message;
											//conso.log(error.code);
											//conso.log(error.Message);

											window.alert("Message:"+errorMessage);					
										}
										else{
											console.log("database entry");
											window.alert(quantity+' Stocks of '+cmpName+' bought successfully')
											document.getElementById("form").reset();
										}
									});
								}
							});
						}
					});
					}
				}
				
			}
		});

		function average(hasdate,buyprice,buyqty,instPriceN,quantityN,cmpName,instDate,TotalQtyN){
			//conso.log(hasdate);
			//conso.log(buyprice);
			//conso.log(buyqty);
			//conso.log(instPriceN);
			//conso.log(quantityN);
			//conso.log(cmpName);
			//conso.log(instDate);
			//conso.log(TotalQtyN);
			var user = firebase.auth().currentUser;
			if(hasdate && user)
			{
				var newbuyprice=parseFloat(buyprice)+parseFloat(instPriceN) ;
				var newQty=parseInt(buyqty)+parseInt(quantityN);
				var newunitprice=parseFloat(newbuyprice)/parseFloat(newQty);
				var userID = firebase.auth().currentUser.uid;
				//conso.log('newbuyprice:'+newbuyprice+'\nnew qty:'+newQty+'\nnewunitprice:'+newunitprice);
				//creating "ROOTREF" for traversing to required note
				var rootRef = firebase.database().ref().child("users").child(userID).child("stocks");
				var date =rootRef.child(cmpName).child(instDate);
				var cmpData = {								
					"Investment Price": newbuyprice,
					"Quantity": newQty.toString(),
					"Unit Price":newunitprice.toString()
				}; 	
				var newTotalQty=parseInt(TotalQtyN)+parseInt(quantityN);
				//conso.log(newTotalQty);
				rootRef.child(cmpName).child('TotalQty').set({
					"TotalQty":newTotalQty.toString()
				});
				date.set(cmpData,function(error){
					if(error){
						var errorcode=error.code;
						var errorMessage=error.message;
						//conso.log(error.code);
						//conso.log(error.Message);

						window.alert("Message:"+errorMessage);					
					}
					else{
						console.log("database entry updated");
						window.alert(quantity+' Stocks of '+cmpName+' bought successfully')
						document.getElementById("form").reset();
					}
				});
			}
			
		}

		function brokragepopup(){
			document.getElementById("brokragepopup").innerHTML="Enter the brokrage i.e charges charged by stock broker(can be found on contract note)";
		}

		function otpopup(){
			document.getElementById("otpopup").innerHTML="Enter other taxes such as STT,ETC(can be found on contract note)";
		}

		function clearpop(){
			document.getElementById("brokragepopup").innerHTML="";
			document.getElementById("otpopup").innerHTML="";
		}

		function convertdates(date){
			var parts =date.split('-');
			// Please pay attention to the month (parts[1]); JavaScript counts months from 0:
			var mydate = new Date(parts[0], parts[1] - 1, parts[2]); 
			//console.log(mydate.toDateString());
			return mydate;
		}

	</script>

</html>
